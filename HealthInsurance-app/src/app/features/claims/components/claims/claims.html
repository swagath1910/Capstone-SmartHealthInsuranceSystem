<div *ngIf="isHospitalStaff()">
  <app-hospital-claims></app-hospital-claims>
</div>

<mat-card *ngIf="!isHospitalStaff()">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>assignment</mat-icon>
      {{isClaimsOfficer() || isAdmin() ? 'Claims for Review' : 'My Claims'}}
    </mat-card-title>
    <div class="spacer"></div>
    <button mat-raised-button color="primary" *ngIf="canCreateClaim()" 
            (click)="createClaim()">
      <mat-icon>add</mat-icon>
      New Claim
    </button>
  </mat-card-header>
  
  <mat-card-content>
    <!-- Search and Filter Section -->
    <div class="filter-section">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search Claims</mat-label>
        <input matInput 
               [(ngModel)]="searchTerm" 
               (ngModelChange)="applyFilters()"
               placeholder="Search by claim number, policy, hospital">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="filter-field">
        <mat-label>Filter by Status</mat-label>
        <mat-select [(ngModel)]="selectedStatus" (ngModelChange)="applyFilters()">
          <mat-option [value]="''">All Status</mat-option>
          <mat-option [value]="ClaimStatus.Submitted">Submitted</mat-option>
          <mat-option [value]="ClaimStatus.InReview">In Review</mat-option>
          <mat-option [value]="ClaimStatus.Approved">Approved</mat-option>
          <mat-option [value]="ClaimStatus.Rejected">Rejected</mat-option>
          <mat-option [value]="ClaimStatus.Paid">Paid</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button (click)="clearFilters()" class="clear-btn">
        <mat-icon>clear</mat-icon>
        Clear Filters
      </button>
    </div>

    <div class="results-info">
      Showing {{paginatedClaims.length}} of {{filteredClaims.length}} {{hasActiveFilters() ? 'filtered' : ''}} claims ({{claims.length}} total)
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="paginatedClaims" matSort (matSortChange)="sortData($event)" class="claims-table">
        <ng-container matColumnDef="claimNumber">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Claim Number</th>
          <td mat-cell *matCellDef="let claim">{{claim.claimNumber}}</td>
        </ng-container>

        <ng-container matColumnDef="userName" *ngIf="showUserColumn()">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Claimant</th>
          <td mat-cell *matCellDef="let claim">{{claim.userName}}</td>
        </ng-container>

        <ng-container matColumnDef="policyNumber">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Policy</th>
          <td mat-cell *matCellDef="let claim">{{claim.policyNumber}}</td>
        </ng-container>

        <ng-container matColumnDef="hospitalName">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Hospital</th>
          <td mat-cell *matCellDef="let claim">{{claim.hospitalName}}</td>
        </ng-container>

        <ng-container matColumnDef="claimAmount">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Amount</th>
          <td mat-cell *matCellDef="let claim">{{claim.claimAmount | currency:'INR':'symbol':'1.0-0'}}</td>
        </ng-container>

        <ng-container matColumnDef="approvedAmount">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Approved</th>
          <td mat-cell *matCellDef="let claim">
            {{claim.approvedAmount ? (claim.approvedAmount | currency:'INR':'symbol':'1.0-0') : '-'}}
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Status</th>
          <td mat-cell *matCellDef="let claim">
            <mat-chip [ngClass]="getStatusClass(claim.status)">
              {{getStatusText(claim.status)}}
            </mat-chip>
          </td>
        </ng-container>

        <ng-container matColumnDef="submittedAt">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Submitted</th>
          <td mat-cell *matCellDef="let claim">{{claim.submittedAt | date:'dd/MM/yyyy'}}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let claim">
            <button mat-icon-button (click)="viewClaim(claim)" 
                    matTooltip="View Details">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button *ngIf="canReviewClaim(claim)" 
                    (click)="reviewClaim(claim)"
                    matTooltip="Review Claim">
              <mat-icon>rate_review</mat-icon>
            </button>
            <button mat-icon-button *ngIf="canMarkAsPaid(claim)" 
                    (click)="markAsPaid(claim)"
                    [disabled]="isProcessingPayment(claim)"
                    matTooltip="Mark as Paid"
                    color="accent">
              <mat-icon *ngIf="!isProcessingPayment(claim)">payment</mat-icon>
              <mat-icon *ngIf="isProcessingPayment(claim)">hourglass_empty</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>

      <div class="empty-state" *ngIf="filteredClaims.length === 0">
        <mat-icon>assignment</mat-icon>
        <p>No claims found</p>
      </div>
    </div>

    <mat-paginator 
      [length]="filteredClaims.length"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 25, 50, 100]"
      [pageIndex]="pageIndex"
      (page)="onPageChange($event)"
      showFirstLastButtons>
    </mat-paginator>
  </mat-card-content>
</mat-card>
